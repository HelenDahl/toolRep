å‘å¸ƒæ—¶é—´ï¼š2025 å¹´ 4 æœˆ 28 æ—¥

**æˆªæ­¢æ—¥æœŸ****ï¼š****2025** **å¹´** **5** **æœˆ** **13** **æ—¥ 23:59:59**

è¯·æ³¨æ„åœ¨æˆªæ­¢æ—¥æœŸå‰æäº¤åˆ°å¯¹åº”ä»“åº“ï¼

åŠ©æ•™ï¼šèµµç†™ï¼ˆemailï¼š fly0307@sjtu.edu.cnï¼‰

ä»“åº“åœ°å€ï¼šhttps://github.com/SJTU-IPADS/OS-Course-Lab/tree/OS-Pre-Course-CSAPP

## **Introduction**

åœ¨è¿™ä¸ª lab ä¸­ï¼Œä½ å°†ä¼šä½¿ç”¨è¯¾å ‚ä¸Šæ‰€æåŠçš„ socket ç¼–ç¨‹ï¼Œç»“åˆ [llama.cpp](https://github.com/ggml-org/llama.cpp) çš„å¯¹è¯æ¨¡å‹å®ç°ä¸€ä¸ª socket serverã€‚æœ¬ lab ä¸€å…±åˆ†ä¸º 5 ä¸ªéƒ¨åˆ†ï¼Œå½“ä½ å…¨éƒ¨å®Œæˆä¹‹åï¼Œå°†èƒ½å¤Ÿåœ¨æµè§ˆå™¨ä¸­ä¸å¤§æ¨¡å‹è¿›è¡Œå¯¹è¯ã€‚

**æ³¨ï¼šè¯¥å®éªŒå…¨éƒ¨ä»å¤´è®¾è®¡ä¸”ç¬¬ä¸€æ¬¡å‘å¸ƒï¼Œå¦‚å¯¹å®éªŒæˆ–æ–‡æ¡£ä¸­ä»»ä½•åœ°æ–¹æœ‰ç–‘é—®ï¼Œæ¬¢è¿å‘åŠ©æ•™****ï¼ˆèµµç†™ï¼Œ****email: fly0307@sjtu.edu.cn****ï¼‰****æå‡ºã€‚**

è¯·ä½ åˆ‡æ¢åˆ°å®éªŒæ–‡ä»¶å¤¹æ ¹ç›®å½•ï¼Œç„¶åé€šè¿‡ä¸‹é¢çš„å‘½ä»¤ä» GitHub æ‹‰å– lab ä»£ç ï¼š

```Bash
#!/bin/bash
# pull codes from GitHub
git switch OS-Pre-Course-CSAPP
git pull

# remove redundant files
ls | grep -v SocketLab | xargs -i rm -rf {}

# move lab files to the root of the project
mv ./SocketLab/* ./SocketLab/.* .
rm -rf ./SocketLab

# commit to our git server
git switch -c lab9
git add --all
git commit -m "initialize lab9"
git push -u origin lab9
```

Socket Lab çš„æ–‡ä»¶ç»“æ„å¦‚ä¸‹æ‰€ç¤ºï¼š

```Bash
.
â”œâ”€â”€ CMakeLists.txt
â”œâ”€â”€ examples            # example files, to show how to use the library
â”‚   â”œâ”€â”€ CMakeLists.txt
â”‚   â”œâ”€â”€ json.c          # JSON library
â”‚   â””â”€â”€ llama.c         # LLaMA library
â”œâ”€â”€ frontend            # frontend, used to present a website in the browser
â”‚   â”œâ”€â”€ Makefile
â”‚   â”œâ”€â”€ node_proxy      # this part will be introduced later
â”‚   â””â”€â”€ website         # the compiled website (written in Vue 3)
â”œâ”€â”€ grade               # files used to grade your lab
â”‚   â”œâ”€â”€ client_test.py              # Part 1: Client
â”‚   â”œâ”€â”€ common_exceptions.py
â”‚   â”œâ”€â”€ common.py
â”‚   â”œâ”€â”€ concurrency_test.py         # Part 3: Concurrency
â”‚   â”œâ”€â”€ connect.js                  # Part 4: WebSocket Access
â”‚   â”œâ”€â”€ epoll_test.py               # Part 3: Epoll Server
â”‚   â”œâ”€â”€ grade.py                    # Grade All-in-One
â”‚   â”œâ”€â”€ Makefile
â”‚   â”œâ”€â”€ message_model.py
â”‚   â”œâ”€â”€ package.json
â”‚   â”œâ”€â”€ package-lock.json
â”‚   â”œâ”€â”€ server_test.py              # Part 2: Server
â”‚   â””â”€â”€ std_answer.py               # Part 4: Standard Answer
â”œâ”€â”€ include             # header files
â”‚   â”œâ”€â”€ config.h
â”‚   â”œâ”€â”€ json            # our JSON library
â”‚   â”œâ”€â”€ llama           # our LLaMA library
â”‚   â””â”€â”€ server.h
â”œâ”€â”€ lib                 # library files
â”‚   â”œâ”€â”€ CMakeLists.txt
â”‚   â”œâ”€â”€ json            # our JSON library
â”‚   â””â”€â”€ llama           # our LLaMA library
â”œâ”€â”€ Makefile
â”œâ”€â”€ models
â”‚   â”œâ”€â”€ model.gguf      # the model file
â”‚   â””â”€â”€ README.md
â”œâ”€â”€ ref                 # client and server Python implementation for reference
â”‚   â”œâ”€â”€ client.py
â”‚   â”œâ”€â”€ server.py
â”‚   â””â”€â”€ message_model.py
â”œâ”€â”€ requirements.txt    # python dependencies you need to install first
â”œâ”€â”€ src                 # the main part of the lab
â”‚   â”œâ”€â”€ client.c
â”‚   â”œâ”€â”€ Makefile
â”‚   â”œâ”€â”€ server.c
â”‚   â””â”€â”€ server_epoll.c
â””â”€â”€ thirdparty          # third-party libraries
    â”œâ”€â”€ json            # JSON library
    â””â”€â”€ llama.cpp       # LLaMA library
```

## **Part 0: Preparation**

åœ¨ lab å¼€å§‹ä¹‹å‰ï¼Œéœ€è¦ä¸€äº›å‡†å¤‡å·¥ä½œã€‚è¯·å®Œæˆæ¥ä¸‹æ¥çš„å‡ æ­¥ï¼Œè¿™æ ·ä½ å°†å¯¹è¿™ä¸ª lab æœ‰ä¸€ä¸ªåˆæ­¥çš„äº†è§£ã€‚

### **Step 1: Initialize the Git Submodule**

é¦–å…ˆï¼Œå¸Œæœ›ä½ äº†è§£ä»€ä¹ˆæ˜¯ Git Submoduleï¼Œä»¥åŠå¦‚ä½•ä½¿ç”¨ã€‚åœ¨è¿™ä¸ª lab ä¸­ï¼Œæˆ‘ä»¬éœ€è¦ç”¨åˆ°ä¸¤ä¸ªç¬¬ä¸‰æ–¹åº“â€”â€”ä¸€æ˜¯ç”¨æ¥å®ç°è‡ªå®šä¹‰æ ¼å¼çš„ JSON åº“ï¼ŒäºŒæ˜¯ llama.cpp çš„æºç ã€‚ä¼—æ‰€å‘¨çŸ¥ï¼ŒC/C++ æ²¡æœ‰ç»Ÿä¸€çš„åŒ…ç®¡ç†å™¨ï¼ˆä¸åƒ Python æœ‰ pipï¼ŒRust æœ‰ cargoï¼‰ï¼Œå› æ­¤æˆ‘ä»¬éœ€è¦å°†è¿™äº›åº“æ–‡ä»¶æ”¾ç½®åœ¨æˆ‘ä»¬çš„é¡¹ç›®ä¸­ç»Ÿä¸€ç®¡ç†ã€‚å½“ç„¶ï¼Œæˆ‘ä»¬å¯ä»¥é€‰æ‹©ç›´æ¥å°†è¿™ä¸¤ä¸ªé¡¹ç›®çš„æºç æ‹·è´è‡³é¡¹ç›®ä¸‹ç„¶ååŠ å…¥åˆ° Git æäº¤ä¸­ï¼Œä½†æ˜¯è¿™æ ·ä¼šä½¿å¾—é¡¹ç›®å˜å¾—è‡ƒè‚¿/ä¸æ¸…æ™°ã€‚å› æ­¤ï¼Œæˆ‘ä»¬å¸Œæœ›ä½ èƒ½å¤Ÿå­¦ä¼šå¦‚ä½•ä½¿ç”¨ Git Submoduleã€‚

Git Submodule æ˜¯æŒ‡åœ¨ä¸€ä¸ª Git é¡¹ç›®ä¸­åµŒå¥—å¦ä¸€ä¸ª Git é¡¹ç›®ä½œä¸ºå­æ¨¡å—ï¼Œå…·ä½“çš„è§„åˆ™å†™åœ¨ `.gitmodules`æ–‡ä»¶ä¸­ã€‚

```Plain
[submodule "thirdparty/json"]
        path = thirdparty/json
        url = https://github.com/nlohmann/json.git
[submodule "thirdparty/llama.cpp"]
        path = thirdparty/llama.cpp
        url = https://github.com/ggml-org/llama.cpp.git
```

å¦‚ä¸Šå›¾æ‰€ç¤ºï¼Œå¯ä»¥çœ‹åˆ°æˆ‘ä»¬çš„é¡¹ç›®é‡Œæœ‰ä¸¤ä¸ªå­æ¨¡å—ï¼Œè¿™ä¸ªæ–‡ä»¶é‡Œå­˜å‚¨äº†å®ƒä»¬çš„ URL å’Œéœ€è¦è¢« clone åˆ°çš„è·¯å¾„ï¼Œäº‹å®ä¸Šï¼Œè¿˜å¯ä»¥å­˜æœ‰æ›´å¤šçš„å†…å®¹â€”â€”æ¯”å¦‚è¦ checkout åˆ°çš„å“ˆå¸Œå€¼ï¼Œè¦åˆ‡æ¢åˆ°çš„åˆ†æ”¯ç­‰ç­‰ã€‚é€šå¸¸æ¥è¯´ï¼Œä¸ºäº†é˜²æ­¢åº“æ–‡ä»¶è¿­ä»£æ›´æ–°é€ æˆå…¼å®¹æ€§é—®é¢˜ï¼Œsubmodules å¾€å¾€ä¼šåŠ ä¸Šéœ€è¦ checkout åˆ°çš„å“ˆå¸Œå€¼ï¼Œä½†æ˜¯æœ¬æ¬¡å®éªŒä½¿ç”¨çš„å°±æ˜¯æœ€æ–°çš„æäº¤ï¼Œå› æ­¤è¿™é‡Œå¹¶æ²¡æœ‰æ·»åŠ ã€‚

å¯¹äºä¸€èˆ¬çš„ Git é¡¹ç›®æ¥è¯´ï¼Œ`.gitmodules`æ–‡ä»¶ä»…ä»…ä¿å­˜å…ƒæ•°æ®ï¼Œè€ŒçœŸæ­£æ³¨å†Œçš„æ¨¡å—ä¿å­˜åœ¨`.git`æ–‡ä»¶å¤¹ä¸­éšç€é¡¹ç›®è¢«æ‹‰å–è€ŒåŒæ­¥ã€‚ä½†æ˜¯æˆ‘ä»¬çš„å®éªŒå‘å¸ƒå°† lab æ–‡ä»¶æ”¾åœ¨ä»“åº“æŸä¸ªå­æ–‡ä»¶å¤¹ä¸­ï¼ˆ`SocketLab`ï¼‰ï¼Œè¿™å°†ä½¿å¾—åˆ é™¤é‡ç»„é‡æ–°æäº¤åå­æ¨¡å—çš„æ³¨å†Œè§„åˆ™å¤±æ•ˆäº†ï¼ˆæ¯”å¦‚ llama.cppï¼ŒåŸå…ˆè·¯å¾„å¯èƒ½æ˜¯`SocketLab/thirdparty/llama.cpp`ï¼Œä½†æ˜¯è¿ç§»ä¹‹åå˜æˆäº†`thirdparty/llama.cpp`ï¼ŒåŸå…ˆçš„æ³¨å†Œä¿¡æ¯å¤±æ•ˆï¼‰ã€‚å› æ­¤åœ¨æœ¬ lab ä¸­ç›®å½•ä¸‹ä»…ä¿ç•™äº†`.gitmodules`ï¼Œåœ¨å®Œæˆäº†æ–‡ä»¶çš„è¿ç§»ä¹‹åï¼Œä½ éœ€è¦é€šè¿‡åœ¨é¡¹ç›®æ ¹ç›®å½•æ‰§è¡Œä¸‹é¢çš„å‘½ä»¤è¡Œè„šæœ¬æ¥æ‹‰å–å­æ¨¡å—ï¼š

```Bash
#!/bin/bash
git config -f .gitmodules --get-regexp '^submodule\..*\.path$' | while read path_key path_val; do
    url_key=$(echo $path_key | sed 's/\.path/.url/')
    url_val=$(git config -f .gitmodules --get "$url_key")
    git submodule add $url_val $path_val
done
```

å¯¹äºæ›´ä¸€èˆ¬çš„åŒ…å«å­æ¨¡å—çš„é¡¹ç›®ï¼Œä¸ºäº†åˆå§‹åŒ–é¡¹ç›®å¹¶æ‹‰å–å­æ¨¡å—ï¼Œå¯ä»¥æ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼ˆæœ¬æ¬¡å®éªŒä¸­ä¸ç”¨ï¼Œä½†æ˜¯å¦‚æœä»¥åä½ é‡æ–°å…‹éš†è‡ªå·±çš„ä»“åº“å¹¶åˆ‡æ¢åˆ°è¿™ä¸ª lab åˆ†æ”¯ï¼Œéœ€è¦ä»¥ä¸‹å‘½ä»¤æ¥æ‹‰å–å­æ¨¡å—ï¼‰ï¼š

```Bash
$ git submodule update --init --recursive
```

### **Step 2: Install Lab Dependencies**

åœ¨è¿™ä¸ª Lab ä¸­ï¼Œä½¿ç”¨åˆ°äº† cmake æ¥ç¼–è¯‘æ•´ä¸ªé¡¹ç›®ï¼Œå¦å¤–ç”¨åˆ°äº† Python æ¥å¯¹ä»£ç è¿›è¡Œæµ‹è¯•ï¼Œå› æ­¤æˆ‘ä»¬éœ€è¦å®‰è£… cmake å’Œ Python ç¯å¢ƒï¼š

```Bash
$ sudo apt update && sudo apt install cmake python3 python3-pip python3-dev -y
$ pip install -r requirements.txt
```

ç­‰å¾…å®‰è£…å®Œæˆä¹‹åï¼Œå°±å¯ä»¥ä½¿ç”¨ Python æ¥å¯¹ä»£ç è¿›è¡Œæµ‹è¯•äº†ã€‚

å¯¹äºæŸäº›åœ¨ Debian/Ubuntu ä¸Šä½¿ç”¨ç³»ç»Ÿçº§ Python çš„åŒå­¦ï¼Œåœ¨æ‰§è¡Œä¸Šé¢çš„ç¬¬äºŒè¡Œæ—¶ï¼Œå¦‚æœä¸ä½¿ç”¨ Virtual Envirenment æˆ–è€… Anaconda ï¼Œå¯èƒ½æ— æ³•ç›´æ¥ä½¿ç”¨ `pip` åœ¨ `site-packages` ä¸­æ·»åŠ éœ€è¦çš„åŒ…ã€‚å¯¹äºè¿™ç§æƒ…å†µï¼Œå¯ä»¥é€šè¿‡ä»¥ä¸‹`apt`å‘½ä»¤å®‰è£…ï¼š

```Bash
$ sudo apt install python3-nest-asyncio cython3 -y
```

> å¦‚æœå®‰è£…cython3åä¾ç„¶ç¼–è¯‘æŠ¥é”™æç¤ºcython: not foundï¼Œå¯æ‰§è¡Œä¸‹è¿°æŒ‡ä»¤è®© cython æŒ‡å‘ cython3
>
> ```Bash
> bash which cython3#æŸ¥çœ‹cython3è·¯å¾„
> sudo ln -s <ä¸Šæ­¥ä¸­cython3è·¯å¾„> /usr/local/bin/cython#è®© cython æŒ‡å‘ cython3
> #æˆ–è€…æ‰§è¡Œsudo ln -s <ä¸Šæ­¥ä¸­cython3è·¯å¾„> /usr/bin/cython
> bash which cython #éªŒè¯æ˜¯å¦èƒ½æ‰¾åˆ°cython
> ```

### **Step 3: Get LLM Model**

è¿™ä¸ª lab ä¸­ä½¿ç”¨åˆ°äº† llama.cpp ä½œä¸ºæˆ‘ä»¬çš„æ¨ç†æ¡†æ¶ï¼Œé¦–å…ˆéœ€è¦è·å–åˆ°ç”¨æ¥æ¨ç†çš„å¤§æ¨¡å‹ã€‚æˆ‘ä»¬ç”¨æ¥æµ‹è¯•çš„æ¨¡å‹æ˜¯ [qwen2.5-coder-1.5b-instruct-q8_0.gguf](https://huggingface.co/Qwen/Qwen2.5-Coder-1.5B-Instruct-GGUF/blob/main/qwen2.5-coder-1.5b-instruct-q8_0.gguf)ï¼Œä½ ä¹Ÿå¯ä»¥é€‰æ‹©ä»»ä¸€ llama.cpp æ”¯æŒçš„æ¨¡å‹ï¼Œä½†æ— è®ºå¦‚ä½•è¯·å°†å…¶**é‡å‘½åä¸º** **`model.gguf`**ç„¶åæ”¾ç½®åœ¨ `models/`ç›®å½•ä¸‹æ–¹ä¾¿åç»­æµ‹è¯•ã€‚

```Bash
$ wget -O models/model.gguf https://104.244.46.244/Qwen/Qwen2.5-Coder-1.5B-Instruct-GGUF/resolve/main/qwen2.5-coder-1.5b-instruct-q8_0.gguf?download=true
```

å¦‚æœä¸Šè¿°ä¸‹è½½æ¨¡å‹å› ç½‘ç»œåŸå› è¶…æ—¶ï¼Œå¯ä»¥ä»è¿™ä¸ª[é“¾æ¥](https://ipads.se.sjtu.edu.cn:1313/d/d64dbab552d04e3586dc/)ä¸‹è½½ï¼š

```Bash
$ wget -O models/model.gguf "https://ipads.se.sjtu.edu.cn:1313/d/d64dbab552d04e3586dc/files/?p=%2Fqwen2.5-coder-1.5b-instruct-q8_0.gguf&dl=1"
```

*åœ¨å®Œæˆè¿™ä¸ª lab ä¹‹åï¼Œä½ å¯ä»¥å°è¯•ä¸‹è½½ä¸€äº›æ›´å¤§çš„æ¨¡å‹ï¼ˆä¸Šé¢çš„è¿™ä¸ªå‚æ•°æ•°é‡æ˜¯ 1.5Bï¼‰ï¼Œæ›¿æ¢ä¹‹åæµ‹è¯•æ•ˆæœï¼Œä½“ä¼šä¸åŒçš„æ¨¡å‹å‚æ•°æ•°é‡ç»™ç”Ÿæˆç»“æœå¸¦æ¥çš„å·®å¼‚ã€‚*

### **Step 4: Compile Examples**

ç”±äºè¿™ä¸ª lab å’Œä»¥å‰æ¶‰åŠçš„ lab å­˜åœ¨ä¸€å®šçš„ä¸åŒâ€”â€”ä½¿ç”¨ CMake æ¥å¯¹è¿™ä¸ªé¡¹ç›®è¿›è¡Œç®¡ç†ï¼Œä¸”å¼•å…¥äº†ç¬¬ä¸‰æ–¹åº“ï¼Œè®©æˆ‘ä»¬å…ˆæ¥ç®€å•çƒ­ä¸ªèº«ã€‚

é¦–å…ˆå›å¿†ä¸€ä¸‹ C è¯­è¨€å’Œ C++ è¯­è¨€çš„åŒºåˆ«ï¼šC è¯­è¨€æ˜¯é¢å‘è¿‡ç¨‹çš„ç¼–ç¨‹è¯­è¨€ï¼Œè€Œ C++ æ˜¯é¢å‘å¯¹è±¡çš„ã€‚å®ƒä»¬ä¸»è¦çš„åŒºåˆ«å°±åœ¨äº C++ æ”¯æŒç±»å‹ç³»ç»ŸåŠå…¶ç»§æ‰¿ï¼Œè€Œ C ç”šè‡³æ²¡æœ‰`std::string`ï¼Œè¿™å°±å¯¼è‡´æ‰‹å†™æŸäº›å¤„ç†å‡½æ•°å˜å¾—éå¸¸ç¹çã€‚ç›¸æ¯”ä¹‹ä¸‹ï¼ŒC++ ä¸­çš„æ ‡å‡†åº“å¦‚`std::vector`å’Œ`std::map`ç­‰éƒ½æ˜¯éå¸¸æ–¹ä¾¿çš„æ•°æ®ç»“æ„ï¼Œä¹Ÿå› æ­¤ llama.cpp å¾ˆå¥½åœ°åˆ©ç”¨äº† C++ çš„é€Ÿåº¦ä¸ä¾¿åˆ©çš„ä¼˜åŠ¿ï¼Œåœ¨ä¿æŒæ¨ç†é€Ÿåº¦çš„åŒæ—¶ä¹Ÿä¸ä¼šé€ æˆä»£ç è¿‡äºç¹çã€‚

C++ éœ€è¦ä¾èµ–äº libstdc++ã€libcï¼Œè€Œæ“ä½œç³»ç»Ÿå±‚æ¬¡å¹¶ä¸å†æ‹¥æœ‰è¿™äº›åº“ï¼Œå› æ­¤åœ¨æ“ä½œç³»ç»Ÿç¼–ç¨‹ä¸­ï¼Œä½¿ç”¨å¾—æ›´å¤šçš„è¯­è¨€è¿˜æ˜¯ Cï¼Œä¹Ÿå¯ä»¥çœ‹åˆ°æœ¬è¯¾ç¨‹å®éªŒä½¿ç”¨çš„ä¸»è¦è¯­è¨€è¿˜æ˜¯ Cã€‚è€Œåœ¨æœ¬ lab ä¸­éœ€è¦å°† C è¯­è¨€å’Œ C++ è¯­è¨€ç»“åˆèµ·æ¥ï¼Œå³éœ€è¦åœ¨ C ç¨‹åºé‡Œé¢ï¼ˆè¦å®ç°çš„`server`å’Œ`client`ï¼‰è°ƒç”¨ C++ çš„åº“ï¼ˆå¦‚ LLaMA åº“ï¼‰ï¼Œè¿™å°±è¦æ±‚ C++ æä¾›ç»™ C çš„å‡½æ•°æ¥å£å¿…é¡»èƒ½å¤Ÿåœ¨ C ä¸­ä½“ç°â€”â€”ä¸èƒ½åŒ…å« `std::vector`ç­‰ç­‰ï¼ˆå› ä¸º C ä¸­å¹¶æ²¡æœ‰è¿™äº›ç±»å‹ï¼‰ã€‚æ–¹ä¾¿èµ·è§ï¼Œæˆ‘ä»¬ä¸º JSON åº“å’Œ LLaMA åº“è¿›è¡Œäº†ä¸€å±‚å°è£…ï¼ˆåœ¨`lib/`æ–‡ä»¶å¤¹ä¸‹ï¼‰ï¼Œä½ éœ€è¦éµå¾ªè¿™ä¸ªåº“æ–‡ä»¶çš„è°ƒç”¨è§„åˆ™ï¼ˆå‚è€ƒ`include/`ç›®å½•ä¸‹çš„å¤´æ–‡ä»¶æ¥å£å£°æ˜ï¼‰ï¼Œè€ƒè™‘å¦‚ä½•åœ¨ä½ çš„ C ä»£ç ä¸­ä½¿ç”¨è¿™ä¸¤ä¸ªåº“ã€‚

å¯ä»¥çœ‹åˆ°ï¼Œåœ¨`examples/`ç›®å½•ä¸‹æœ‰ä¸¤ä¸ªæ–‡ä»¶ï¼Œ`json.c`å’Œ`llama.c`ï¼Œæˆ‘ä»¬æä¾›è¿™ä¸¤ä¸ªæ–‡ä»¶ä½œä¸ºè°ƒç”¨çš„ä¾‹å­ã€‚æ¥ä¸‹æ¥è¯·ä½ ç¼–è¯‘è¿™ä¸ªé¡¹ç›®ï¼Œæ‰§è¡Œï¼š

```Bash
$ mkdir build
$ make build
```

è¿™å°†ä¼šåœ¨ `build/`ç›®å½•ä¸‹é…ç½® CMake å¹¶è¿›è¡Œç¼–è¯‘ã€‚`json.c`å’Œ`llama.c`ä¼šåˆ†åˆ«è¢«ç¼–è¯‘åˆ°`build/examples/json_example`å’Œ`build/examples/llama_example`çš„ä½ç½®ã€‚

æ¥ä¸‹æ¥å°è¯•è¿è¡Œè¿™ä¸¤ä¸ªå¯æ‰§è¡Œæ–‡ä»¶ï¼ˆä¸‹é¢çš„å‘½ä»¤æ˜¯åœ¨é¡¹ç›®æ ¹ç›®å½•æ‰§è¡Œçš„ç¤ºä¾‹ï¼Œå¦‚ä¸åœ¨æ ¹ç›®å½•ï¼Œè¯·è‡ªè¡Œæ ¹æ®å¯æ‰§è¡Œæ–‡ä»¶å’Œæ¨¡å‹æ–‡ä»¶çš„è·¯å¾„è¿›è¡Œä¿®æ”¹ï¼‰ï¼Œåˆ†åˆ«æ‰§è¡Œä¸‹è¿°æŒ‡ä»¤ï¼š

```Bash
$ ./build/examples/json_example
$ ./build/examples/llama_example -m ./models/model.gguf
```

è¿è¡Œåè¾“å‡ºå†…å®¹å¦‚ä¸‹ï¼š

```Bash
$ ./build/examples/json_example
class: ICS
semester: 2024-2025-2
$ ./build/examples/llama_example -m ./models/model.gguf
............................................................................
User llama_client_1 asks: è¯·è®°ä½æˆ‘æ˜¯ICSåŠ©æ•™ã€‚
Response: å½“ç„¶ï¼Œæˆ‘ä¼šè®°ä½ä½ æ˜¯ICSåŠ©æ•™ã€‚
The current response has ended

User llama_client_1 asks: è¯·é—®æˆ‘æ˜¯è°ï¼Ÿ
Response: æˆ‘æ˜¯ICSåŠ©æ•™ã€‚
The current response has ended

User llama_client_2 asks: è¯·é—®æˆ‘æ˜¯è°ï¼Ÿ
Response: æˆ‘æ˜¯äººå·¥æ™ºèƒ½åŠ©æ‰‹ï¼Œæ²¡æœ‰ä¸ªäººèº«ä»½ã€‚
The current response has ended
```

ä½ éœ€è¦æŸ¥çœ‹`json.c`å’Œ`llama.c`çš„æºç ï¼Œäº†è§£å¦‚ä½•è°ƒç”¨è¿™ä¸¤ä¸ªåº“ï¼Œåœ¨è¿™ä¸ªè¿‡ç¨‹é‡Œï¼Œå¯ä»¥åŠ æ·±å¯¹ C è¯­è¨€é¢å‘è¿‡ç¨‹çš„ç‰¹æ€§çš„è®¤è¯†ã€‚è¿™é‡Œå¯¹`llama.c`çš„æºç æµç¨‹ä½œä¸€å®šçš„è§£é‡Šï¼š

```c
static void quest_wrapper(int conn, const char *client_name,
                          const char *message) {
    // Log the message to the console
    printf("User %s asks: %s\n", client_name, message);
    printf("Response: ");

    // Call the quest function to get the response
    quest_for_response(conn, client_name, message);
    printf("\n");
}

int main(int argc, char *argv[]) {
    // Parse command line arguments
    if (argc != 3 || strcmp(argv[1], "-m") != 0) {
        fprintf(stderr, "Usage: %s -m <model_path>\n", argv[0]);
        return 1;
    }

    // Example usage of the LLaMA CLI
    if (initialize_llama_chat(argc, argv) != 0)
        return 1;

    // Add clients
    const char *client_names[] = {"llama_client_1", "llama_client_2"};
    for (int i = 0; i < sizeof(client_names) / sizeof(client_names[0]); ++i) {
        if (add_chat_user(client_names[i]) != 0) {
            fprintf(stderr, "Failed to add client: %s\n", client_names[i]);
            free_llama_chat();
            return 1;
        }
    }

    // Execute the quest function for the client
    quest_wrapper(0, client_names[0], "è¯·è®°ä½æˆ‘æ˜¯ICSåŠ©æ•™ã€‚");
    quest_wrapper(0, client_names[0], "è¯·é—®æˆ‘æ˜¯è°ï¼Ÿ");

    // Execute the quest function using another client
    // The second client will not be able to see the first client's messages
    quest_wrapper(0, client_names[1], "è¯·é—®æˆ‘æ˜¯è°ï¼Ÿ");

    // Free the llama chat resources
    for (int i = 0; i < sizeof(client_names) / sizeof(client_names[0]); ++i) {
        if (remove_chat_user(client_names[i]) != 0) {
            fprintf(stderr, "Failed to remove client: %s\n", client_names[i]);
        }
    }

    // Free the llama CLI resources
    free_llama_chat();
    return 0;
}
```

åœ¨`main`å‡½æ•°ä¸­ï¼Œé¦–å…ˆè§£æå‘½ä»¤è¡Œå‚æ•°è·å–åˆ°æ¨¡å‹æ–‡ä»¶ï¼Œæ¥ç€åˆå§‹åŒ–æ¨¡å‹ï¼Œç„¶åå‘ llama æ³¨å†Œäº†ä¸¤ä¸ªä¸åŒçš„ç”¨æˆ·ï¼ˆä¸¤ä¸ªç”¨æˆ·ä¼šå…·æœ‰ä¸åŒçš„ä¸Šä¸‹æ–‡ï¼‰ã€‚æ¥ç€è°ƒç”¨å°è£…å¥½çš„`quest_for_response`å‡½æ•°è¿›è¡Œæ¨ç†ï¼ˆåœ¨`quest_wrapper`å‡½æ•°ä¸­ï¼‰ï¼Œè¿™ä¸ªå‡½æ•°ä¼šæ ¹æ®ä¼ å…¥çš„`client_name`æŸ¥æ‰¾å¯¹åº”çš„ä¸Šä¸‹æ–‡ï¼Œç„¶åæ ¹æ®è¯¥ä¸Šä¸‹æ–‡è¿›è¡Œæ¨ç†ï¼Œå¹¶å°†æ¨ç†ç»“æœæ”¾å›åˆ°ä¸Šä¸‹æ–‡ä¸­ä»¥ä¾›ä¸‹ä¸€æ¬¡æ¨ç†ã€‚æœ€åè¯·ä¸è¦å¿˜è®°é‡Šæ”¾èµ„æºâ€”â€”å…ˆå°†æ³¨å†Œè¿‡çš„ç”¨æˆ·æ‰€ç”¨çš„ä¸Šä¸‹æ–‡ç§»é™¤ï¼Œç„¶åé‡Šæ”¾å¤§æ¨¡å‹å ç”¨çš„èµ„æºã€‚

é¦–å…ˆéœ€è¦è¯´æ˜çš„æ˜¯ï¼šè¿™ä¸ªæµ‹è¯•å¹¶æ²¡æœ‰è¿›è¡Œä»»ä½• socket çš„è¿æ¥æˆ–ä¿¡æ¯çš„å‘é€ï¼Œ`llama.c`ä¸­çš„ä¸¤ä¸ªå‡½æ•°`send_token`å’Œ`send_eog_token`åœ¨ LLaMA åº“ä¸­è¢«è°ƒç”¨ï¼Œè¿™ä¸¤ä¸ªå‡½æ•°å¯ä»¥åœ¨ä¸‹é¢çš„ **Part 2: Implement the Server Using Multi-Threading Way** ä¸­æ‰¾åˆ°è¯¦ç»†è§£é‡Šã€‚è¿™ä¸ªç¤ºä¾‹é‡Œæˆ‘ä»¬ä»…ä»…å°†å„ token æ‹¼å‡‘åœ¨ä¸€èµ·æ”¾åœ¨`buffer`æ•°ç»„ä¸­ï¼Œå¹¶åœ¨æ¯æ¬¡ç”Ÿæˆç»“æŸæ—¶è°ƒç”¨çš„`send_eog_token`ä¸­æ‰“å°ä¸€è¡Œå­—ç¬¦ã€‚è€Œåœ¨åé¢çš„å®ç° server æ­¥éª¤ä¸­ï¼Œä½ éœ€è¦åœ¨è¿™ä¸¤ä¸ªå‡½æ•°é‡Œå®ç° socket å‘é€è¿‡ç¨‹ï¼ŒåŒ…æ‹¬å°è£…ä»¥åŠå‘é€ï¼Œè¿™æ ·æ‰èƒ½çœŸæ­£è¿›è¡Œ socket é€šä¿¡ã€‚

å¦å¤–ï¼Œå¯ä»¥çœ‹åˆ°`llama.c`ä¸­å­˜åœ¨ä¸¤ä¸ªç”¨æˆ·å…ˆåå‘å¤§æ¨¡å‹æé—®ï¼Œä»–ä»¬æ ¹æ®ä¸åŒçš„åå­—è¿›è¡ŒåŒºåˆ†â€”â€”ä¸Šé¢çš„å›å¤ä¸­ä¹Ÿå¯ä»¥çœ‹åˆ°ï¼Œç¬¬ä¸€ä¸ªç”¨æˆ·å‘Šè¯‰äº†æ¨¡å‹ä»–çš„èº«ä»½ï¼Œè€Œç¬¬äºŒä¸ªç”¨æˆ·å¹¶æ²¡æœ‰ï¼Œäºæ˜¯ç¬¬äºŒä¸ªç”¨æˆ·çš„å›ç­”ä¸ç¬¬ä¸€ä¸ªç”¨æˆ·å…³äºâ€œæˆ‘æ˜¯è°â€çš„å›ç­”ä¸åŒã€‚å› æ­¤ä½ éœ€è¦å¦¥å–„ç®¡ç†ä¸åŒçš„ç”¨æˆ·â€”â€”å…³äºä¿å­˜ä¸åŒç”¨æˆ·ä¸Šä¸‹æ–‡å†…éƒ¨çš„å¤„ç†æˆ‘ä»¬å·²ç»å®ç°å¥½äº†ï¼Œä½ åªéœ€è¦å§‹ç»ˆä¿æŒåŒä¸€ä¸ªç”¨æˆ·ä½¿ç”¨åŒä¸€ä¸ªç”¨æˆ·åå³å¯ï¼Œ**é‚£ä¹ˆå¦‚ä½•ä¿è¯ç”¨æˆ·åä¸å‘ç”Ÿå†²çªä¼šæ˜¯è¿™ä¸ª lab ä¸­ä½ éœ€è¦æ€è€ƒå¹¶è§£å†³çš„ä¸€ä¸ªé—®é¢˜ã€‚**

### **Step 5: Test Example Client and Server**

ä¸ºäº†æ–¹ä¾¿æµ‹è¯•ï¼Œæˆ‘ä»¬ä»¥ Python å½¢å¼ç»™å‡ºäº†ç¤ºä¾‹å’Œæµ‹è¯•æ‰€ç”¨çš„ client å’Œ serverï¼ˆä¸åŒ…æ‹¬ç¬¬ä¸‰éƒ¨åˆ†ä½¿ç”¨ epoll å®ç°çš„ serverï¼‰ï¼Œè¯·ä½ å…ˆæ‰§è¡Œ client å’Œ server è¿›è¡Œç®€å•çš„æµ‹è¯•ä¸ä½“ä¼šã€‚

æˆ‘ä»¬é¦–å…ˆå¯åŠ¨ serverï¼Œè¯·æ³¨æ„ï¼Œserver å‘½ä»¤è¡Œå‚æ•°éœ€æ­£ç¡®æŒ‡å®šæ¨¡å‹çš„ä½ç½®ï¼š

**è‹¥åœ¨æœ¬åœ°æ€§èƒ½è¾ƒå·®çš„è™šæ‹Ÿæœºä¸­å¯åŠ¨** **server** **å¯èƒ½æ—¶é—´è¾ƒé•¿ï¼Œå¦‚æœå¯åŠ¨æ—¶é—´è¿‡é•¿ï¼Œä¸ºé¿å…** **4** **ä¸ª** **part** **æµ‹è¯•è¶…æ—¶æˆ–æµ‹è¯•ä¸ç¨³å®šï¼Œå¯åœ¨æœ¬åœ°æš‚æ—¶ä¿®æ”¹æµ‹è¯•è„šæœ¬** **grade** **ç›®å½•ä¸‹å„****`open_client`****å‡½æ•°ä¸­çš„è¶…æ—¶é‡è¯•é—´éš”ï¼Œå½“å‰é»˜è®¤ä¸º** **1s**

```Bash
$ python3 ./ref/server.py -m ./models/model.gguf
............................................................................
The server has been started, listening on: 127.0.0.1:12345
```

æ¥ç€åœ¨æ–°çš„ç»ˆç«¯å¯åŠ¨ client ä¸ server è¿›è¡Œè¿æ¥ï¼š

```Bash
$ python3 ./ref/client.py
Connected to 127.0.0.1:12345
> 
```

è¾“å…¥æµ‹è¯•é—®é¢˜â€œä½ å¥½!â€ï¼Œå¯ä»¥çœ‹åˆ° client å’Œ server ä¾§è¿›è¡Œæµå¼å›å¤ï¼š

```Bash
$ python3 ./ref/server.py -m ./models/model.gguf
............................................................................
The server has been started, listening on: 127.0.0.1:12345
Client connected from: ('127.0.0.1', 44266)
Received ('127.0.0.1', 44266): {"token": "\u4f60\u597d!", "eog": true}
ä½ å¥½ï¼æœ‰ä»€ä¹ˆæˆ‘å¯ä»¥å¸®å¿™çš„å—ï¼Ÿ
$ python3 ./ref/client.py
Connected to 127.0.0.1:12345
> ä½ å¥½!
ä½ å¥½ï¼æœ‰ä»€ä¹ˆæˆ‘å¯ä»¥å¸®å¿™çš„å—ï¼Ÿ
> 
```

ä½ åœ¨ä¸‹é¢çš„ä¸‰ä¸ªéƒ¨åˆ†ä¸­éœ€è¦å®ç°çš„æ•ˆæœåº”è¯¥ä¸è¿™é‡Œçš„ç±»ä¼¼ã€‚

æ³¨æ„ï¼šè¯·å°½é‡**ä½¿ç”¨è‹±æ–‡è¿›è¡Œå¯¹è¯**ï¼Œå› ä¸º C è¯­è¨€åœ¨å¤„ç† UTF-8 ä¸­æ–‡å­—ç¬¦çš„æ—¶å€™å¯èƒ½ä¼šé‡åˆ°æˆªæ–­ç­‰é—®é¢˜ï¼Œå¯¼è‡´ JSON åº“å‡ºç°è§£ææŠ¥é”™ã€‚å½“ç„¶ï¼Œä¸€èˆ¬æƒ…å†µä¸‹æ˜¯æ²¡æœ‰é—®é¢˜çš„ã€‚

**è‹¥åœ¨æœ¬åœ°æ€§èƒ½è¾ƒå·®çš„è™šæ‹Ÿæœºä¸­å¯åŠ¨ server å¯èƒ½æ—¶é—´è¾ƒé•¿ï¼Œå¦‚æœå¯åŠ¨æ—¶é—´è¿‡é•¿ï¼Œä¸ºé¿å… 4 ä¸ª part æµ‹è¯•è¶…æ—¶æˆ–æµ‹è¯•ä¸ç¨³å®šï¼Œå¯åœ¨æœ¬åœ°æš‚æ—¶ä¿®æ”¹æµ‹è¯•è„šæœ¬ grade ç›®å½•ä¸‹****`open_client`****å‡½æ•°ä¸­çš„è¶…æ—¶é‡è¯•é—´éš”ï¼Œå½“å‰é»˜è®¤ä¸º 1s**

## **Part 1: Warmup: Implement the Client**

åœ¨è¿™ä¸ªéƒ¨åˆ†ï¼Œä½ éœ€è¦å®ç°ä¸€ä¸ª client ç”¨äºä¸ server è¿›è¡Œé€šä¿¡ã€‚å…ˆæ€è€ƒä¸€ä¸‹ client å’Œ server çš„ä¸åŒç‚¹ï¼šclient åªéœ€è¦è¿›è¡Œç®€å•çš„å‘é€è¯·æ±‚ï¼Œç„¶åæ¥æ”¶æ¥è‡ª server çš„å›å¤ï¼Œè€Œ server åˆ™å¯èƒ½ä¼šé¢å¯¹ç€å¾ˆå¤šçš„ client åŒæ—¶è¯·æ±‚ï¼Œé‚£ä¹ˆå¦‚ä½•ä¿è¯èµ„æºç«äº‰ä¸­ä¸å‘ç”Ÿå†²çªï¼Œä»¥åŠå°½å¯èƒ½è®© client çš„è¯·æ±‚å¾—åˆ°åŠæ—¶çš„å“åº”ï¼Œè¿™å°±æ˜¯ server éœ€è¦è§£å†³çš„ä¸€ä¸ªé—®é¢˜ã€‚è€Œ client ç›¸å¯¹æ›´ç®€å•ï¼Œåªéœ€è¦å®ç°ä¸€ä¸ªå•çº¿ç¨‹çš„ socket å‘é€æ¥æ”¶å³å¯ã€‚

åœ¨`config.h`ä¸­ï¼Œæˆ‘ä»¬è®¾å®šäº†å‡ ä¸ªå¸¸é‡ä¾›ä½ ä½¿ç”¨ï¼ˆé™¤éå‘ç”Ÿç«¯å£å ç”¨å†²çªï¼Œå¦åˆ™ä¸ç”¨ä¿®æ”¹ï¼‰ï¼š

```C
#define SERVER_ADDR "127.0.0.1"
#define SERVER_PORT 12345
#define MAX_BUFFER_SIZE 1024
```

å¦å¤–éœ€è¦è¯´æ˜çš„æ˜¯ï¼Œserver é€šè¿‡ socket å‘ client å‘é€çš„æ¶ˆæ¯æ ¼å¼æ˜¯ JSONï¼Œè¯·ä½ è°ƒç”¨ç›¸å…³åº“å¯¹è¿™ä¸ª JSON æ ¼å¼çš„å­—ç¬¦ä¸²è¿›è¡Œååºåˆ—åŒ–ä»è€Œè·å–åˆ°å…¶ä¸­çš„ token å¹¶æ‰“å°åœ¨ç»ˆç«¯ä¸Šã€‚ä½¿ç”¨çš„ JSON æ ¼å¼å¦‚ä¸‹ï¼š

```JavaScript
{
    "token": "",
    "eog": true
}
```

`token`æ˜¯ä¸ºäº†å’Œ server è¿›è¡Œæµå¼å›å¤æ—¶çš„å‘é€æ ¼å¼ç›¸å¯¹åº”ï¼Œåœ¨ client ä¾§ï¼Œå‘é€ç»™ server çš„ JSON ä¸­ï¼Œ`token`å­—æ®µåº”è¯¥åŒ…å«å•æ¬¡æé—®çš„ promptï¼Œè€Œ`eog`å­—æ®µåº”è¯¥è®¾ç½®ä¸º`true`ã€‚

åœ¨ä»£ç ä¸­æˆ‘ä»¬æä¾›äº†è¾ƒå¤šçš„æ³¨é‡Šï¼Œè¯·ä½ å‚è€ƒä»£ç ä¸­çš„æ³¨é‡Šï¼Œç»“åˆè¯¾ä¸Šæ‰€å­¦ï¼Œå®Œæˆ client è¿™éƒ¨åˆ†ä»£ç ã€‚ä½ æ‰€éœ€è¦å®ç°çš„ client éœ€è¦å…·å¤‡æä¾›çš„ Python client æ‰€å…·æœ‰çš„åŠŸèƒ½ã€‚åœ¨å®Œæˆä¹‹åï¼Œä½ å¯ä»¥ä½¿ç”¨ä¸‹é¢çš„å‘½ä»¤æ¥æµ‹è¯•ä½ çš„ clientï¼š

```Bash
$ make grade-part1
```

è¿™å°†ä½¿ç”¨æä¾›çš„ Python client å’Œä½ å®ç°çš„ client åˆ†åˆ«ä¸æä¾›çš„ Python server è¿›è¡Œäº¤äº’ï¼Œå¯¹æ¯”å®ƒä»¬çš„è¾“å‡ºæ˜¯å¦ä¸€è‡´ã€‚ä½ çš„ client **è¿æ¥ä¸Š server ä¹‹åéœ€è¦æ‰“å°ä¸€è¡Œä»¥ "connected" å¼€å¤´çš„ä¿¡æ¯**å¦‚`Connected to 127.0.0.1:12345`ï¼Œè¿™æ ·æµ‹è¯•ç¨‹åºæ‰èƒ½åˆ¤æ–­ä½ ä¸ server å»ºç«‹äº†è¿æ¥ï¼Œæ‰ä¼šç»§ç»­è¿›è¡Œä¸‹ä¸€æ­¥è¯„æµ‹ã€‚å¦‚æœæ­£ç¡®å®ç°`client.c`ï¼Œä½ å°†ä¼šçœ‹åˆ°ç±»ä¼¼äºä¸‹é¢çš„è¾“å‡ºï¼š

```Bash
$ make grade-part1
python3 grade/client_test.py
connect failed: Connection refused
............................................................................
Client Output:     > **Hello! How can I assist you today?**
Reference Output:  > **Hello! How can I assist you today?**
Final Score:       20
```

æ³¨ï¼š*ä¸Šé¢çš„**`connect failed`**ä¸éœ€è¦ careï¼Œå› ä¸º server å¯åŠ¨éœ€è¦ä¸€å®šçš„æ—¶é—´ï¼Œæ‰€ä»¥æµ‹è¯•ä¸­ä¼šä¸æ–­å°è¯•è¿æ¥åˆ° serverï¼Œåªè¦æœ€ç»ˆ**è¾“å‡º**æ˜¯æ­£ç¡®**ï¼Œå¾—åˆ°è¯„åˆ†**å³å¯ã€‚**å¦å¤–ï¼Œè¯·ä¸è¦ä½¿ç”¨ Hack çš„æ–¹å¼é€šè¿‡ç›´æ¥å‘é€å›ºå®šçš„è¾“å‡ºæ¥é€šè¿‡è¿™ä¸ªå®éªŒï¼Œ**è¯„åˆ†**æµ‹è¯•çš„æ—¶å€™ä¼šä½¿ç”¨ä¸åŒçš„ Prompt* *åŠ**ä¸åŒçš„æ¨¡å‹ :)*

## **Part 2: Implement the Server Using Multi-Threading Way**

åœ¨è¿™ä¸ªéƒ¨åˆ†ï¼Œä½ éœ€è¦å®ç°ä¸€ä¸ª serverï¼Œç”¨äºæ¥æ”¶ client çš„è¯·æ±‚ï¼Œå¹¶è¿”å›å¯¹è¯è¡¥å…¨çš„ç»“æœã€‚ç°åœ¨è¯·ä½ å›æƒ³è¯¾å ‚ä¸Šæ‰€è®²åˆ°çš„ä¸‰ç§å®ç°å¹¶å‘ server çš„æ–¹å¼â€”â€”**å¤šè¿›ç¨‹ã€å¤šçº¿ç¨‹ã€IO å¤šè·¯å¤ç”¨**ã€‚ç”±äºå¤šè¿›ç¨‹å’Œå¤šçº¿ç¨‹åœ¨å®ç°ä¸Šç›¸å·®æ— å‡ ï¼Œå¹¶ä¸”åˆ›å»ºè¿›ç¨‹çš„å¼€é”€è¦å¤§äºåˆ›å»ºçº¿ç¨‹ï¼Œå› æ­¤åœ¨è¿™ä¸ª lab ä¸­æˆ‘ä»¬ä¸è¿›è¡Œå¤šè¿›ç¨‹æ–¹å¼çš„å®ç°ã€‚è¿™ä¸ªéƒ¨åˆ†å¸Œæœ›ä½ ä½¿ç”¨**å¤šçº¿ç¨‹**çš„æ–¹å¼æ¥å®ç° serverã€‚

server éƒ¨åˆ†çš„ç»“æ„ç›¸å¯¹è¾ƒå¤æ‚ï¼Œè¿™é‡Œå…ˆä»‹ç»ä¸€ä¸‹`server.h`ä¸­ç›¸å…³çš„ä¸¤ä¸ªå‡½æ•°ï¼š

```C
#pragma once

#ifdef __cplusplus
extern "C" {
#endif

void send_token(int conn, const char *token);
void send_eog_token(int conn);

#ifdef __cplusplus
}
#endif
```

è¿™ä¸¤ä¸ªå‡½æ•°åœ¨ LLaMA åº“ä¸­è¢«è°ƒç”¨ï¼Œä¹Ÿæ˜¯ä½ éœ€è¦å®ç°çš„ä¸€éƒ¨åˆ†ã€‚

LLaMA ä¸­ç›¸å…³çš„è°ƒç”¨å¦‚ä¸‹ï¼š

```C++
    // ä¸‹é¢çš„å¾ªç¯ç”¨æ¥æ‰§è¡Œæ¨ç†
    while (true) {
        // ......è¿™é‡Œçœç•¥äº†å¾ˆé•¿ä¸€éƒ¨åˆ†ä»£ç 

        // convert the token to a string, print it and add it to the response
        char buf[256];
        int n = llama_token_to_piece(vocab, new_token_id, buf, sizeof(buf), 0,
                                     true);    // å°†è¾“å‡ºçš„tokenè½¬åŒ–æˆword
        if (n < 0) {
            GGML_ABORT("failed to convert token to piece\n");
        }
        std::string piece(buf, n);
        printf("%s", piece.c_str());    // æ‰“å°å‡ºå½“å‰tokenåˆ°ç»ˆç«¯
        fflush(stdout);
        response += piece;              // æ‹¼å‡‘åˆ°responseä¸­

        // send the piece to the client
        send_token(chat_user.conn, piece.c_str()); // å‡½æ•°è°ƒç”¨ï¼Œå°†å½“å‰tokenå‘é€åˆ°clienté‡Œ

        // prepare the next batch with the sampled token
        batch = llama_batch_get_one(&new_token_id, 1);
    }

    // send the EOG token to the client
    send_eog_token(chat_user.conn);    // å‡½æ•°è°ƒç”¨ï¼Œå‘é€ç»“æŸç¬¦åˆ°clientï¼Œå‘ŠçŸ¥clientå½“å‰å¯¹è¯ç”Ÿæˆå®Œæ¯•
    return response;
```

è¿™é‡Œä¸æ–­ç”Ÿæˆ token ç›´åˆ°é‡åˆ°`eog`ï¼ˆend of generationï¼‰ï¼Œä½ éœ€è¦ä½¿ç”¨ JSON åº“å¯¹è¿™ä¸ªæ¶ˆæ¯è¿›è¡Œå°è£…ï¼Œç„¶åå‘é€åˆ° clientï¼Œå› æ­¤è¿™ä¸¤ä¸ªå‡½æ•°å°±æˆä¸º**å°è£…**å’Œ**å‘é€**çš„å…³é”®ã€‚

åœ¨è¿™ä¸ª part ä¸­ï¼Œä½ å°†ç®€å•åœ°ä¸ºæ¯ä¸€ä¸ª accept çš„ client åˆ›å»ºä¸€ä¸ªçº¿ç¨‹ï¼Œç„¶ååœ¨è¿™ä¸ªçº¿ç¨‹ä¸­ä¸æ–­å¤„ç†è¿™ä¸ª client çš„è¯·æ±‚ï¼Œç›´åˆ° client æˆ– server æ–­å¼€è¿æ¥ã€‚åœ¨å®Œæˆ`server.c`ä¹‹åï¼Œä½ å¯ä»¥ä½¿ç”¨ä¸‹é¢çš„å‘½ä»¤æ¥æµ‹è¯•ä½ çš„ serverï¼š

```Bash
$ make grade-part2
```

å¦‚æœå®ç°æ— è¯¯ï¼Œä½ å°†ä¼šçœ‹åˆ°ç±»ä¼¼ä¸‹é¢çš„è¾“å‡ºï¼š

```Bash
$ make grade-part2
python3 grade/server_test.py
connect failed: Connection refused
............................................................................
connect failed: Connection refused
............................................................................
Connected to 127.0.0.1:12345
Connected to 127.0.0.1:12345
Connected to 127.0.0.1:12345
Connected to 127.0.0.1:12345
Connected to 127.0.0.1:12345
Connected to 127.0.0.1:12345
Connected to 127.0.0.1:12345
Connected to 127.0.0.1:12345
Connected to 127.0.0.1:12345
Connected to 127.0.0.1:12345
Final Score: 30
```

## **Part 3: Implement the Server Using IO Multiplexing Way**

åœ¨è¿™ä¸ªéƒ¨åˆ†ï¼Œä½ éœ€è¦å®ç°ä¸€ä¸ª serverï¼Œç”¨äºæ¥æ”¶ client çš„è¯·æ±‚ï¼Œå¹¶è¿”å›å¯¹è¯è¡¥å…¨çš„ç»“æœã€‚è¿™ä¸ªéƒ¨åˆ†å¸Œæœ›ä½ ä½¿ç”¨ IO å¤šè·¯å¤ç”¨çš„æ–¹å¼æ¥å®ç° serverã€‚ä½ éœ€è¦ä¿®æ”¹çš„æ–‡ä»¶æ˜¯ `src/server_epoll.c`ï¼Œå…¶ä»–æ–‡ä»¶å¦‚ Part 2 ä¸­æ‰€è¿°ï¼Œä¸‹é¢æˆ‘ä»¬ç®€å•ä»‹ç»ä¸€ä¸‹ `src/server_epoll.c`ã€‚

åœ¨è¯¾å ‚ä¸Šï¼Œæˆ‘ä»¬è®²åˆ°äº† IO å¤šè·¯å¤ç”¨çš„ select æ–¹å¼ï¼Œä½†æ˜¯ select ç›¸å¯¹æ˜¾å¾—æ›´ç¹çä¸”å¯è¯»æ€§ä¸å¼ºï¼Œè€Œä¸”ç°åœ¨çš„ IO å¤šè·¯å¤ç”¨ç¼–ç¨‹ä¹ŸåŸºæœ¬ä¸Šéƒ½ç”± select å’Œ poll è½¬å‘äº† epollã€‚å› æ­¤åœ¨è¿™ä¸ª part ä¸­ï¼Œæˆ‘ä»¬å¸Œæœ›ä½ ä½¿ç”¨ epoll æ¥å®ç° IO å¤šè·¯å¤ç”¨ï¼Œåœ¨æµ‹è¯„æ—¶ï¼Œæˆ‘ä»¬ä¼šåˆ›å»ºå¾ˆå¤šä¸ªä»…è¿æ¥è€Œä¸å‘é€ä»»ä½•è¯·æ±‚çš„ clientï¼Œæ­¤æ—¶ä½ çš„ server å…·æœ‰çš„çº¿ç¨‹æ•°å¿…é¡»ç­‰äº`1`ã€‚**æ³¨æ„ï¼š**ç”±äºè¯„æµ‹å¹¶ä¸æ£€æŸ¥å…·ä½“å®ç°é€»è¾‘ï¼Œä½ ä¹Ÿå¯ä»¥ä½¿ç”¨ poll è¿›è¡Œå®ç°ï¼Œä½†æ˜¯è¯·ä¸è¦ä½¿ç”¨ select æ–¹å¼ï¼Œå› ä¸ºæµ‹è¯•ä¸­çš„ client æ€»æ•°å·²ç»è¶…è¿‡äº† select æ–¹å¼çš„æœ€å¤§ç›‘å¬æ•°é‡ï¼ˆLinux ä¸Šé€šå¸¸ä¸º 1024ï¼‰ã€‚

æ¥ä¸‹æ¥æˆ‘ä»¬ç®€è¦ä»‹ç»ä¸€ä¸‹ IO å¤šè·¯å¤ç”¨çš„ä¼˜åŠ¿ã€‚åœ¨ Part 2 ä¸­ï¼Œä½ å·²ç»å®ç°äº†ä¸€ä¸ªå¤šçº¿ç¨‹çš„ serverï¼Œè¿™ä¸ª server ä¼šå¯¹æ¯ä¸€ä¸ª client åˆ›å»ºä¸€ä¸ªçº¿ç¨‹ï¼Œç„¶ååœ¨è¿™ä¸ªçº¿ç¨‹ä¸­å¤„ç†è¿™ä¸ª client çš„è¯·æ±‚ã€‚ä½†æ˜¯è¿™æ ·çš„æ–¹å¼ä¼šå¸¦æ¥ä¸€äº›é—®é¢˜ï¼Œå¦‚æœæœ‰å¾ˆå¤šçš„ client åŒæ—¶å»ºç«‹è¿æ¥ï¼Œä½†æ˜¯å¹¶ä¸å¯¹ server å‘é€æ•°æ®ï¼Œé‚£ä¹ˆè¿™äº›åˆ›å»ºå‡ºæ¥çš„çº¿ç¨‹å°±ä¸€ç›´é—²ç½®ç€ã€‚å°½ç®¡åœ¨ Unix ç³»ç»Ÿä¸­ï¼Œé—²ç½®çš„çº¿ç¨‹å¹¶ä¸ä¼šå ç”¨å¤ªå¤šçš„èµ„æºï¼Œä½†æ˜¯åˆ›å»º/é”€æ¯çº¿ç¨‹ä»ç„¶æœ‰ä¸€å®šå¼€é”€ã€‚è€Œ IO å¤šè·¯å¤ç”¨çš„æ–¹å¼åˆ™å¯ä»¥è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œåœ¨è¿™ä¸ªæ–¹å¼ä¸­ï¼Œæˆ‘ä»¬åªéœ€è¦ä¸€ä¸ªçº¿ç¨‹æ¥ç›‘å¬æ‰€æœ‰é˜»å¡çš„æ–‡ä»¶æè¿°ç¬¦ï¼Œå½“æœ‰æ–‡ä»¶æè¿°ç¬¦å°±ç»ªæ—¶ï¼Œåˆ›å»ºä¸€ä¸ªçº¿ç¨‹æ¥å¤„ç†è¿™ä¸ªæ–‡ä»¶æè¿°ç¬¦ã€‚è¿™æ ·å°±å¯ä»¥åšåˆ°**æŒ‰éœ€åˆ›å»º**ï¼Œå¯¹èµ„æºçš„åˆ©ç”¨æ›´åŠ é«˜æ•ˆã€‚

æ¥ä¸‹æ¥æˆ‘ä»¬å†ç®€å•ä»‹ç»ä¸€ä¸‹ epoll å®ç°çš„äº‹ä»¶é©±åŠ¨å‹ IO å¤šè·¯å¤ç”¨ã€‚epoll æ˜¯ Linux ä¸‹çš„ä¸€ç§ IO å¤šè·¯å¤ç”¨æœºåˆ¶ï¼Œå®ƒå¯ä»¥ç›‘å¬å¤šä¸ªæ–‡ä»¶æè¿°ç¬¦ï¼Œå½“å…¶ä¸­æœ‰æ–‡ä»¶æè¿°ç¬¦å°±ç»ªæ—¶ï¼Œå®ƒä¼šä»¥äº‹ä»¶çš„å½¢å¼é€šçŸ¥ä½ ã€‚epoll æœ‰ä¸‰ä¸ªä¸»è¦çš„å‡½æ•°ï¼š`epoll_create1`ã€`epoll_ctl`å’Œ`epoll_wait`ã€‚

- `epoll_create1`æ¥æ”¶ä¸€ä¸ªå‚æ•°`flag`ï¼ˆä¸éœ€è¦è€ƒè™‘ï¼Œç›´æ¥ä¼ å…¥`0`å³å¯ï¼‰ï¼Œè¿”å› epoll å®ä¾‹çš„æ–‡ä»¶æè¿°ç¬¦ã€‚è¯¥å‡½æ•°ç”¨äºåˆ›å»ºä¸€ä¸ª epoll å®ä¾‹ã€‚
- `epoll_ctl`æ¥æ”¶å››ä¸ªå‚æ•°ï¼Œç¬¬ä¸€ä¸ªå‚æ•°æ˜¯å‰é¢ç”¨`epoll_create`åˆ›å»ºå‡ºçš„ epoll çš„æ–‡ä»¶æè¿°ç¬¦ï¼›ç¬¬äºŒä¸ªå‚æ•°æ˜¯è¡¨æ˜å‘ epoll å®ä¾‹ä¸­æ·»åŠ ï¼ˆ`EPOLL_CTL_ADD`ï¼‰è¿˜æ˜¯åˆ é™¤ï¼ˆ`EPOLL_CTL_DEL`ï¼‰æ–‡ä»¶æè¿°ç¬¦ï¼›ç¬¬ä¸‰ä¸ªå‚æ•°æ˜¯è¦æ·»åŠ /åˆ é™¤çš„æ–‡ä»¶æè¿°ç¬¦ï¼Œè€Œç¬¬å››ä¸ªå‚æ•°æ˜¯æŒ‡å‘ä¸€ä¸ªäº‹ä»¶ç»“æ„ä½“ï¼ˆ`struct epoll_event`ï¼‰çš„æŒ‡é’ˆï¼Œæ·»åŠ æ—¶è®¾ç½®`{ .events=EPOLLIN, .data``.fd``=fd }`ï¼Œè€Œåˆ é™¤æ—¶ç½®ç©ºå³å¯ã€‚è¯¥å‡½æ•°ç”¨äºå‘ epoll å®ä¾‹ä¸­æ·»åŠ /åˆ é™¤æ–‡ä»¶æè¿°ç¬¦ã€‚(å¦‚æœè®¾ç½®äº† `EPOLLIN` æ ‡å¿—ï¼Œè¿™æ„å‘³ä½ å¸Œæœ›åœ¨è¯¥æ–‡ä»¶æè¿°ç¬¦fdå˜ä¸ºå¯è¯»çŠ¶æ€æ—¶å¾—åˆ°é€šçŸ¥)
- `epoll_wait`æ¥æ”¶å››ä¸ªå‚æ•°ï¼Œç¬¬ä¸€ä¸ªå‚æ•°æ˜¯å‰é¢ç”¨`epoll_create`åˆ›å»ºå‡ºçš„ epoll çš„æ–‡ä»¶æè¿°ç¬¦ï¼Œç¬¬äºŒä¸ªå‚æ•°æ˜¯ä¸€ä¸ªäº‹ä»¶ç»“æ„ä½“ï¼ˆ`struct epoll_event`ï¼‰çš„æ•°ç»„ï¼Œç¬¬ä¸‰ä¸ªå‚æ•°æ˜¯æ•°ç»„çš„å¤§å°ï¼Œç¬¬å››ä¸ªå‚æ•°æ˜¯è¶…æ—¶æ—¶é—´ï¼ˆç”±äºæœ¬ lab ä¸­ client ä¼šåœ¨ä¸ç¡®å®šçš„æ—¶é—´å‘é€æ¶ˆæ¯ï¼Œæ²¡æœ‰å»ºç«‹å¿ƒè·³æœºåˆ¶ï¼Œæ•…å°†è¯¥å‚æ•°è®¾ç½®ä¸º`-1`ï¼‰ï¼Œè¿”å›å€¼`n`æ˜¯å°±ç»ªçš„æ–‡ä»¶æè¿°ç¬¦çš„ä¸ªæ•°ï¼Œè¡¨æ˜ç¬¬äºŒä¸ªå‚æ•°çš„äº‹ä»¶ç»“æ„ä½“æ•°ç»„çš„å‰`n`ä¸ªå…ƒç´ å‡ä¸º ready çš„äº‹ä»¶ã€‚å½“è¯¥å€¼ä¸º`0`æ—¶ï¼Œè¡¨æ˜ä¸éœ€è¦è¿›è¡Œå¤„ç†ï¼Œåº”è¯¥è¿›å…¥ä¸‹ä¸€æ¬¡ç­‰å¾…ï¼Œå½“è¯¥å€¼å¤§äº`0`æ—¶ï¼Œéœ€è¦ä»`0`åˆ°`n`éå†äº‹ä»¶æ•°ç»„ï¼ŒæŸ¥çœ‹å“ªä¸€äº›äº‹ä»¶äºŸå¾…å¤„ç†ï¼Œè€Œå¦‚æœå®ƒå°äº`0`ï¼Œè¯´æ˜å‡ºç°äº†é”™è¯¯ï¼Œæ¯”å¦‚ç”¨æˆ·é”®å…¥`CTRL + C`ä¸­æ–­ serverã€‚è¯¥å‡½æ•°ç”¨äºç­‰å¾…æ–‡ä»¶æè¿°ç¬¦å°±ç»ªã€‚

æ¥ä¸‹æ¥æˆ‘ä»¬å¸Œæœ›ä½ æ€è€ƒä½¿ç”¨ epoll IO å¤šè·¯å¤ç”¨çš„æ–¹å¼æ¥å®ç° server çš„ä¸€æ•´å¥—æµç¨‹ï¼Œè¿™é‡Œæˆ‘ä»¬æä¾›ä¸€ä¸ªå‚è€ƒæµç¨‹ï¼š

1. åˆ›å»ºä¸€ä¸ª epoll å®ä¾‹ã€‚
2. æ‰“å¼€ä¸€ä¸ª socketï¼Œç»‘å®šåˆ°ä¸€ä¸ªç«¯å£ä¸Šï¼Œç„¶åç›‘å¬è¿™ä¸ª socketã€‚
3. å°†è¿™ä¸ª socket æ·»åŠ åˆ° epoll å®ä¾‹ä¸­ã€‚
4. è¿›å…¥ä¸€ä¸ªå¾ªç¯ï¼Œä¸æ–­è°ƒç”¨`epoll_wait`ï¼Œç­‰å¾…æ–‡ä»¶æè¿°ç¬¦å°±ç»ªã€‚
5. å½“æœ‰æ–‡ä»¶æè¿°ç¬¦å°±ç»ªæ—¶ï¼Œéå†äº‹ä»¶æ•°ç»„ï¼ŒæŸ¥çœ‹å“ªä¸€äº›äº‹ä»¶äºŸå¾…å¤„ç†ã€‚
   1. å¦‚æœæ˜¯ç›‘å¬ socket å°±ç»ªï¼Œè¡¨æ˜æœ‰æ–°çš„ client è¿æ¥ï¼Œé‚£ä¹ˆä½ éœ€è¦æ¥å—è¿™ä¸ªè¿æ¥ï¼Œå¹¶å°†è¿™ä¸ª client çš„ socket æ·»åŠ åˆ° epoll å®ä¾‹ä¸­ã€‚
   2. å¦‚æœæ˜¯ client å¯¹åº”çš„ fd å°±ç»ªï¼Œè¡¨æ˜è¿™ä¸ª client å‘é€äº†æ¶ˆæ¯ï¼Œé‚£ä¹ˆä½ éœ€è¦æ¥æ”¶è¿™ä¸ªæ¶ˆæ¯ï¼Œåˆ›å»ºæ–°çº¿ç¨‹è°ƒç”¨æ¨ç†å‡½æ•°ï¼Œä»è€Œè¿”å›å¯¹è¯è¡¥å…¨çš„ç»“æœã€‚
6. é‡å¤ 4-5 æ­¥ï¼Œç›´åˆ° server è¢«ä¸­æ–­ã€‚

è¯·æ ¹æ®ä»£ç ä¸­ç»™å‡ºçš„æ³¨é‡Šï¼Œå¼€å§‹ä½ çš„ epoll ä¹‹æ—…å§ï¼åœ¨å®ç°ä¹‹åï¼Œä½ å¯ä»¥ä½¿ç”¨ä¸‹é¢çš„å‘½ä»¤æ¥æµ‹è¯•ä½ çš„ serverï¼š

```Bash
$ make grade-part3
```

å¦‚æœä½ çš„å®ç°æ­£ç¡®ï¼Œä½ å°†ä¼šçœ‹åˆ°ä¸‹é¢çš„ç»“æœï¼š

```Bash
$ make grade-part3
python3 grade/epoll_test.py
connect failed: Connection refused
............................................................................
Connected to 127.0.0.1:12345
Connected to 127.0.0.1:12345
Connected to 127.0.0.1:12345
Connected to 127.0.0.1:12345
Connected to 127.0.0.1:12345
Connected to 127.0.0.1:12345
Connected to 127.0.0.1:12345
Connected to 127.0.0.1:12345
Connected to 127.0.0.1:12345
Connected to 127.0.0.1:12345
<æ­¤å¤„çœç•¥éå¸¸éå¸¸å¤šâ€œConnected to 127.0.0.1:12345â€>
Final Score: 30
```

**érootç”¨æˆ·è¿è¡Œï¼Œ****å¦‚æœå‡ºç°æŠ¥é”™****`[Errno 24] Too many open files`****ï¼Œå¯ä»¥æ‰§è¡Œ****`ulimit -n unlimited`****(æˆ–****`ulimit -n 2048`****)****å°†å•ä¸ªè¿›ç¨‹çš„ fd æ•°é‡é™åˆ¶æ”¹ä¸ºæ— é™åˆ¶**

å®Œæˆ Part 3 åï¼Œè¯·è¿è¡Œé›†æˆæµ‹è¯•ï¼ˆå¤§çº¦3åˆ°4åˆ†é’Ÿï¼‰ï¼š

```Bash
$ make grade
```

å¦‚æœå®ç°æ­£ç¡®ï¼Œä½ å°†ä¼šçœ‹åˆ°ç±»ä¼¼ä¸‹é¢çš„è¾“å‡ºï¼š

```Bash
$ make grade
python3 grade/grade.py
<æ­¤å¤„çœç•¥CMake Build Log>
connect failed: Connection refused
............................................................................
............................................................................
client_test.py: 20
server_test.py: 30
concurrency_test.py: 20
epoll_test.py: 30
Final Score: 100
```

æ¥ä¸‹æ¥æˆ‘ä»¬çœ‹ä¸€ä¸‹ concurrency_testï¼Œè¿™ä¸ªæµ‹è¯•ä¸­æˆ‘ä»¬ä¼šå°è¯•å»ºç«‹å¾ˆå¤šç©ºè¿æ¥â€”â€”å¦‚æœè¿˜æ˜¯å¦‚ Part 2 è¿™æ ·çš„å®ç°ï¼Œå»ºç«‹ 1024 ä¸ªç©ºè¿æ¥ä¼šåˆ›å»º 1024 ä¸ªçº¿ç¨‹ï¼Œç›¸åº”åœ°ä¼šå¸¦æ¥éå¸¸å¤§çš„å¼€é”€ã€‚ä½ å¯ä»¥æŸ¥çœ‹è¿™éƒ¨åˆ†æµ‹è¯•çš„æºç ï¼Œå¯ä»¥äº†è§£åˆ°æµ‹è¯•ä½¿ç”¨çš„æ–¹æ³•æœ€ç»ˆæ¯”è¾ƒçš„æ˜¯è¿è¡Œæ—¶é—´å·®ã€‚æ¯”å¦‚ï¼š

```Bash
$ python3 ./grade/concurrency_test.py
Connected to 127.0.0.1:12345
Connected to 127.0.0.1:12345
Connected to 127.0.0.1:12345
Connected to 127.0.0.1:12345
<æ­¤å¤„çœç•¥éå¸¸éå¸¸å¤šâ€œConnected to 127.0.0.1:12345â€>
Time Difference: 2.209076404571533
Final Score:     20
```

å¯ä»¥çœ‹åˆ°æ—¶é—´å¤šåˆ›å»º 1024 ä¸ª client å¸¦æ¥çš„æ—¶é—´å·®ä»…ä¸º 2.2sï¼Œä½†æ˜¯å¦‚æœä¿®æ”¹ `concurrency_test.py`çš„ç¬¬95è¡Œï¼Œæ”¹ä¸ºä½¿ç”¨æ™®é€šçš„ä¸€å¯¹ä¸€åˆ›å»ºï¼Œæˆ‘ä»¬å°±å¯ä»¥çœ‹åˆ°æ˜æ˜¾çš„æ•ˆç‡ä¹‹å·®äº†ï¼š

```Diff
diff --git a/grade/concurrency_test.py b/grade/concurrency_test.py
index 744c782..ef76d5e 100644
--- a/grade/concurrency_test.py
+++ b/grade/concurrency_test.py
@@ -92,7 +92,7 @@ def main() -> None:
         time.sleep(0.1)
 
     # open the C server
-    server_process = open_server(subprocess_server_epoll)
+    server_process = open_server(subprocess_server)
     client_process = open_client(subprocess_client_ref)
 
     # write "Hello" to stdin of the client
```

æ”¹ä¸ºè°ƒç”¨ Part 2 ä¸­çš„ server è¿›è¡Œç›¸åŒçš„æµ‹è¯•ï¼š

```Bash
$ python3 ./grade/concurrency_test.py
Connected to 127.0.0.1:12345
Connected to 127.0.0.1:12345
Connected to 127.0.0.1:12345
Connected to 127.0.0.1:12345
<æ­¤å¤„çœç•¥éå¸¸éå¸¸å¤šâ€œConnected to 127.0.0.1:12345â€>
Time Difference: 84.80091166496277
Final Score:     0
```

å»ºè®®ä½ åŠ¨æ‰‹å°è¯•ä¸€ä¸‹ï¼Œç›¸ä¿¡åˆ°è¿™é‡Œä½ èƒ½å¤Ÿå¯¹ IO å¤šè·¯å¤ç”¨æœ‰ä¸€ä¸ªæ›´æ·±çš„ç†è§£ã€‚

## **Part 4: Website Demonstration**

åœ¨è¿™ä¸€éƒ¨åˆ†ï¼Œæˆ‘ä»¬ä¼šå°†æˆ‘ä»¬å®ç°çš„ server çœŸæ­£æ¥å…¥åˆ°æµè§ˆå™¨ä¸­ã€‚ä¸ºäº†åé¢è¿›è¡Œæµ‹è¯„ï¼Œè¯·ä½ å…ˆè¿è¡Œä¸‹é¢è¿™æ¡å‘½ä»¤ç”Ÿæˆè¯„æµ‹æ ‡å‡†ç­”æ¡ˆ`std_answer.txt`ï¼š

```Bash
$ make prepare-part4
```

æ¥ä¸‹æ¥æˆ‘ä»¬æ¥äº†è§£ä¸€ä¸‹å‰ç«¯éƒ¨åˆ†â€”â€”æˆ‘ä»¬ä¸ºè¿™ä¸ªå¤§æ¨¡å‹å¯¹è¯å®ç°äº†ä¸€ä¸ªå‰ç«¯ï¼Œä½ å¯ä»¥åœ¨æµè§ˆå™¨ä¸­è¾“å…¥å¯¹è¯ï¼Œç„¶åé€šè¿‡ socket ä¸ server è¿›è¡Œé€šä¿¡ï¼Œæœ€åå¾—åˆ°å¤§æ¨¡å‹ç”Ÿæˆçš„å“åº”ã€‚è¿™ä¸ªå‰ç«¯çš„æ–‡ä»¶ç»“æ„å¦‚ä¸‹ï¼š

```Bash
.
â””â”€â”€ frontend            # frontend, used to present a website in the browser
    â”œâ”€â”€ Makefile        # Makefile
    â”œâ”€â”€ node_proxy      # accept the request from the browser and send it to the server
    â””â”€â”€ website         # the static page to be presented in the browser
```

è¿™é‡Œå…ˆå¯¹è¿™ä¸ªé¡¹ç›®ç»“æ„è¿›è¡Œä¸€ä¸ªç®€å•çš„è¯´æ˜ï¼šä¸ºäº†èƒ½å¤Ÿåœ¨å‰ç«¯å±•ç¤ºï¼Œå·²ç»ä½¿ç”¨ Vue 3 ç¼–å†™äº†ä¸€ä¸ªå‰ç«¯ç½‘é¡µï¼Œç¼–è¯‘å®Œæˆä¹‹åæ”¾åœ¨`frontend/website`æ–‡ä»¶å¤¹ä¸‹ã€‚ä½†ç”±äºç°ä»£æµè§ˆå™¨çš„é™åˆ¶ï¼Œå»ºç«‹ socket è¿æ¥ä¹‹å‰å¿…é¡»è¿›è¡Œ http æ¡æ‰‹ï¼Œè¿™å°±å¯¼è‡´ä½¿ç”¨ C è¯­è¨€ç¼–å†™çš„ server æ— æ³•ç›´æ¥ä¸å‰ç«¯è¿›è¡Œé€šä¿¡ã€‚å› æ­¤å·²ç»åœ¨`frontend/node_proxy`æ–‡ä»¶å¤¹ä¸‹å®ç°äº†ä¸€ä¸ªç®€å•çš„ Node.js ä»£ç†æœåŠ¡å™¨ï¼Œè¿™ä¸ªä»£ç†ä¸å‰ç«¯è¿›è¡Œ socket é€šä¿¡ï¼Œç„¶åå°†å‰ç«¯çš„è¯·æ±‚è½¬å‘ç»™ C è¯­è¨€ç¼–å†™çš„ serverï¼Œæœ€åå°† server çš„å›å¤è¿”å›ç»™å‰ç«¯ã€‚è¿™æ ·ä¸€æ¥ï¼Œæˆ‘ä»¬å°±å¯ä»¥åœ¨æµè§ˆå™¨ä¸­è¾“å…¥å¯¹è¯ï¼Œç„¶åå¾—åˆ°å¯¹è¯è¡¥å…¨çš„ç»“æœã€‚

**æ³¨**ï¼šå¦‚æœä½ ä½¿ç”¨çš„æ˜¯ Dockerï¼ˆå¦‚æˆ‘ä»¬è¯¾ç¨‹æœ€å¼€å§‹æ‰€è¿°ï¼‰ï¼Œè¯·æ³¨æ„ï¼ŒDocker é»˜è®¤å¯åŠ¨æ—¶ä½¿ç”¨â€œæ¡¥æ¥â€çš„ç½‘ç»œæ¨¡å¼ï¼Œè¿™ä¼šåœ¨å®¹å™¨å†…éƒ¨åˆ›å»ºä¸€ä¸ªç›¸å¯¹ç‹¬ç«‹çš„ç½‘ç»œã€‚å› æ­¤ä½ å¯èƒ½éœ€è¦å¯åŠ¨ä¸€ä¸ªæ–°çš„ Docker å®¹å™¨ï¼ˆæ·»åŠ `--network host`å‚æ•°ï¼Œå³â€œé•œåƒâ€çš„ç½‘ç»œæ¨¡å¼ï¼Œè¯¥æ¨¡å¼ä¼šç›´æ¥ä½¿ç”¨å®¿ä¸»æœºçš„ç½‘ç»œï¼‰ï¼Œç„¶ååœ¨è¿™ä¸ªå®¹å™¨ä¸­æ‰§è¡Œä¸‹é¢çš„æ“ä½œã€‚æˆ–è€…ä½ å¯ä»¥é€‰æ‹©åœ¨ä¸»æœºä¸Šå®‰è£… Node.js å’Œ Pythonï¼Œç„¶ååŒæ ·åœ¨ä¸»æœºä¸Šæ‰§è¡Œä¸‹é¢çš„å‘½ä»¤ï¼Œä½†æ˜¯éœ€è¦å¦‚ä¸‹çš„é¢å¤–ä¸€äº›æ“ä½œï¼Œè¯·çœ‹ä¸‹é¢çš„è§£é‡Šã€‚

å¦‚æœä½ å‰é¢çš„ Lab å‡åœ¨ Windows ä¸Šä½¿ç”¨ WSL 2 å®Œæˆï¼Œé‚£ä¹ˆé…ç½®ä½¿ç”¨é•œåƒæ¨¡å¼å°†ä¼šå˜å¾—å¾ˆç®€å•ã€‚ä½ éœ€è¦åšçš„äº‹æƒ…æ˜¯ï¼Œåœ¨ç”¨æˆ·ç›®å½•ä¸‹ï¼ˆé€šå¸¸æ¥è¯´æ˜¯`C:\Users\<your-user-name>`ï¼‰ï¼Œåˆ›å»ºä¸€ä¸ªæ–‡ä»¶ `.wslconfig` ï¼Œå‘å…¶ä¸­å†™å…¥ä»¥ä¸‹å†…å®¹ï¼š

> ```
> [wsl2]
> networkingMode=mirrored
> ```

æ‰§è¡Œ `wsl --shutdown` é‡å¯ WSL åï¼Œå³å¯ä»¥é•œåƒç½‘ç»œæ¨¡å¼å¯åŠ¨ WSL 2 ï¼Œç„¶åè·Ÿéšåé¢çš„æ­¥éª¤åšå³å¯ã€‚

å¦‚æœä½ å‰é¢çš„ Lab å‡åœ¨ Windows ä¸Šä½¿ç”¨ Docker å®Œæˆï¼Œé‚£ä¹ˆå¾ˆé—æ†¾ï¼Œ Windows ä¸Šçš„ Docker Engine å·²ç»ç§»é™¤äº†â€œ**ä¸ºæ¯ä¸ªå®¹å™¨ç»™å®šä¸€ä¸ª IP**â€çš„ç‰¹æ€§ï¼ˆå¦‚æœä½ æ„Ÿå…´è¶£çš„è¯ï¼Œå¯ä»¥æŸ¥çœ‹è¿™ä¸ª [GitHub Issue](https://github.com/docker/roadmap/issues/93) ï¼‰ã€‚é‚£ä¹ˆä¸ºäº†å®Œæˆè¿™éƒ¨åˆ†å·¥ä½œï¼Œä½ å¯èƒ½è¿˜æ˜¯éœ€è¦é‡æ–°å¯åŠ¨ä¸€ä¸ªå®¹å™¨ï¼Œå¹¶åœ¨å¯åŠ¨æ—¶æŒ‡å®š`--network host`æ¥ä½¿ç”¨ Host ç½‘ç»œï¼Œæˆ–è€…æ˜ å°„ç«¯å£`-p 5175:5175`æ¥å°†å®¹å™¨ä¸­çš„ç«¯å£æ˜ å°„åˆ°ä¸»æœºä¸Šã€‚ä¸‹é¢æˆ‘ä»¬æä¾›ä¸€äº›å‘½ä»¤ä¾›å‚è€ƒï¼š

> ```
> docker run --name socket_server -p 5175:5175 -it ics bash
> sudo apt update
> sudo apt install cmake make python3 python3-pip nodejs npm -y
> ```

ï¼ˆåœ¨å¦ä¸€ä¸ªç»ˆç«¯ä¸­ï¼‰

> ```
> docker cp <your_lab_folder> socket_server:/home/ics/
> docker exec -it socket_server bash
> cd /home/ics/<your_lab_folder>
> ./build/src/server
> ```

ï¼ˆå†åœ¨å¦ä¸€ä¸ªç»ˆç«¯ä¸­ï¼‰

> ```
> docker exec -it socket_server bash
> cd /home/ics/<your_lab_folder>
> make middleware
> ```

ç„¶ååœ¨æµè§ˆå™¨ä¸­è®¿é—®[ç½‘ç«™](http://202.120.40.8:10680/courses/ics/labs/socketlab/)ï¼Œæˆ–è€…åœ¨ Host æœºå™¨ä¸Šæ‰§è¡Œä¸‹é¢çš„ç¬¬ä¸‰æ­¥ï¼ˆå¦‚æœæ²¡æœ‰å®‰è£…`make`ï¼Œå¯ä»¥å°† Makefile ä¸­çš„å‘½ä»¤å¤åˆ¶å‡ºæ¥è¿è¡Œï¼‰å³å¯ã€‚

å¦‚æœä½ å‰é¢çš„ Lab æ˜¯åœ¨ Linux/Mac ä¸Šä½¿ç”¨ Docker å®Œæˆï¼Œå¹¶ä¸”å®¹å™¨ç½‘ç»œé‡‡ç”¨æ¡¥æ¥æ¨¡å¼ï¼Œä½ å¯ä»¥é€‰æ‹©åœ¨ä¸»æœºä¸Šå®‰è£… Node.js å’Œ Pythonï¼Œç„¶åä½ éœ€è¦åœ¨ä»£ç†æœåŠ¡å™¨é…ç½®ä¸­è¿›è¡Œä¸€äº›ä¿®æ”¹ã€‚åœ¨`frontend/node_proxy/src`æ–‡ä»¶å¤¹ä¸‹ï¼Œæœ‰ä¸€ä¸ª`proxy.js`æ–‡ä»¶ï¼Œä½ éœ€è¦ä¿®æ”¹å…¶ä¸­çš„`TCP_SERVER_HOST`å­—æ®µï¼Œå°†å…¶ä¿®æ”¹ä¸ºä½ çš„å®¹å™¨çš„ IP åœ°å€ï¼ˆå¯ä»¥æŸ¥çœ‹[è¿™ç¯‡æ–‡ç« ](https://www.howtogeek.com/devops/how-to-get-a-docker-containers-ip-address-from-the-host/)ï¼‰ã€‚ç„¶åä½ éœ€è¦åœ¨`include`æ–‡ä»¶å¤¹ä¸‹çš„`config.h`æ–‡ä»¶ä¸­ä¿®æ”¹`SERVER_ADDR`å­—æ®µï¼Œå°†å…¶ç”±`127.0.0.1`ä¿®æ”¹ä¸º`0.0.0.0`ï¼Œè¿™æ ·ä½ çš„ server å°†ä¼šç›‘å¬æ‰€æœ‰çš„ IP åœ°å€ï¼ˆæ­¤æ—¶ä¸»æœºè®¿é—®å®¹å™¨ç»è¿‡ Docker Bridgeï¼Œé€šå¸¸ä¸º`172.17.0.1`ï¼Œå¦‚æœä»ç„¶ä»…ç›‘å¬`127.0.0.1`çš„è¯ï¼Œä¼šæ‹’ç»æ‰æ¥è‡ª`172.17.0.1`çš„è¿æ¥ï¼‰ã€‚ç„¶åä½ éœ€è¦é‡æ–°ç¼–è¯‘å¹¶åœ¨å®¹å™¨ä¸­å¯åŠ¨ serverï¼š`./build/src/server -m ./models/model.gguf`ï¼Œå…¶ä½™æ­¥éª¤å’Œä¸‹é¢çš„ç›¸åŒï¼ˆåœ¨ Host å®¿ä¸»æœºä¸Šæ‰§è¡Œå‰©ä½™æ­¥éª¤ï¼‰ã€‚

ä¸‹é¢æˆ‘ä»¬ä»‹ç»ç›´æ¥**åœ¨ Linux** **å®¿ä¸»æœº****ä¸Š**ï¼Œ**æˆ–è€…é‡‡ç”¨é•œåƒæ¨¡å¼****ï¼ˆæ·»åŠ ****`--network host`****å‚æ•°ï¼‰****å¯åŠ¨****çš„****å®¹å™¨****ä¸­**æ‰€éœ€è¦è¿›è¡Œçš„æ“ä½œï¼š

1. å®‰è£… Node.jsï¼Œå› ä¸ºä»£ç†æœåŠ¡å™¨ä½¿ç”¨ Node.js ç¼–å†™ï¼Œå¹¶éœ€è¦`npm`æ¥å®‰è£…ä¾èµ–ã€‚
   1. `sudo apt install nodejs npm -y`
   2. æ³¨ï¼šäº‹å®ä¸Šï¼Œapt ä»“åº“ä¸­çš„ Node.js ç‰ˆæœ¬éå¸¸é™ˆæ—§ï¼Œä½†æ˜¯ç”±äºè¿™ä¸ªä»£ç†æœåŠ¡å™¨çš„ä»£ç éå¸¸ç®€å•ï¼Œæ—§ç‰ˆæœ¬çš„ Node.js ä¹Ÿå¯ä»¥è¿è¡Œã€‚
2. æ‰§è¡Œ`make middleware`ï¼Œè¿™ä¼šå®‰è£…ä»£ç†æœåŠ¡å™¨çš„ä¾èµ–ï¼Œå¹¶å¯åŠ¨ä»£ç†æœåŠ¡å™¨ã€‚
   1. ```Bash
      $ make middleware
      make -C frontend middleware
      make[1]: è¿›å…¥ç›®å½•â€œ./frontendâ€
      make -C node_proxy
      make[2]: è¿›å…¥ç›®å½•â€œ./frontend/node_proxyâ€
      node src/proxy.js
      WebSocket server started on port 5175
      New WebSocket client connected.
      Connected to TCP server.
      ```
3. å¦å¤–ä¸€ä¸ªç»ˆç«¯ä¸­æ‰§è¡Œ`make ``website`ï¼Œè¿™å°†ä¼šè°ƒç”¨ Python çš„`http.server`æ¨¡å—ï¼Œåœ¨`8000`ç«¯å£å¯åŠ¨ä¸€ä¸ªç®€å•çš„ http æœåŠ¡å™¨ï¼Œæ¥ç€è®¿é—®`http://localhost:8000`ï¼Œä½ å°†ä¼šçœ‹åˆ°ä¸€ä¸ªç®€å•çš„ç½‘é¡µï¼Œä½ å¯ä»¥åœ¨è¿™ä¸ªç½‘é¡µä¸­è¾“å…¥å¯¹è¯ï¼Œç„¶åå¾—åˆ°å¯¹è¯è¡¥å…¨çš„ç»“æœã€‚
   1. ```Bash
      $ make website
      make -C frontend website
      make[1]: è¿›å…¥ç›®å½•â€œ./frontendâ€
      python3 -m http.server --directory website
      Serving HTTP on 0.0.0.0 port 8000 (http://0.0.0.0:8000/) ...
      ```

   2. æ³¨ï¼šç¬¬ 3 æ­¥å¹¶ä¸å¿…é¡»ï¼Œå› ä¸ºæˆ‘ä»¬å·²ç»åœ¨æœåŠ¡å™¨ä¸Šéƒ¨ç½²äº†ä¸€ä¸ªå‰ç«¯ï¼Œä½ å¯ä»¥ç›´æ¥è®¿é—®[ç½‘ç«™](http://202.120.40.8:10680/courses/ics/labs/socketlab/)æ¥æŸ¥çœ‹è€Œä¸å¿…åœ¨æœ¬åœ°éƒ¨ç½²ã€‚ä½†æ˜¯æ³¨æ„ï¼Œç¬¬ 2 æ­¥çš„**ä»£ç†æœåŠ¡å™¨**ä¸­é—´ä»¶å¿…é¡»åœ¨æœ¬åœ°éƒ¨ç½²ã€‚
4. å¯åŠ¨æœ¬åœ°çš„ serverï¼Œç„¶ååˆ·æ–°ç½‘é¡µï¼Œåœ¨ç½‘é¡µä¸­è¾“å…¥ promptï¼ŒæŸ¥çœ‹æ¨¡å‹ç”Ÿæˆçš„å¯¹è¯ã€‚

![img](https://ipads.feishu.cn/space/api/box/stream/download/asynccode/?code=NzQ0MzkyZmJkMjc1ODI3MDk3MTczZmQzMDcyN2EyNDVfWU1JNG1HYm1SckNkUHdGc25EM1FBMFA2OHRFckNNSXpfVG9rZW46QTVQemJNRWZNb1RHVVF4b21XV2M5N3hPbmNjXzE3NDcxMDYzMzg6MTc0NzEwOTkzOF9WNA)

æ¥ä¸‹æ¥å¯¹ä½ çš„å‰ç«¯éƒ¨ç½²è¿›è¡Œè¯„æµ‹ï¼Œå°†ç”¨ Node.js æ¨¡æ‹Ÿå‰ç«¯å‘é€ä¿¡æ¯ï¼Œç„¶åä¸`std_answer.txt`è¿›è¡Œæ¯”è¾ƒã€‚è¯·æ‰§è¡Œä¸‹é¢çš„å‘½ä»¤è¿›è¡Œè¯„æµ‹ï¼š

```Bash
# åœ¨å®¿ä¸»æœºæˆ–è€…ä½¿ç”¨é•œåƒç½‘ç»œï¼ˆæ·»åŠ --network hostå‚æ•°ï¼‰çš„å®¹å™¨ä¸­æ‰§è¡Œ
$ make grade-part4
```

å¦‚æœä½ çš„æ“ä½œæ­£ç¡®ï¼Œå°†å¯ä»¥çœ‹åˆ°ç±»ä¼¼äºä¸‹é¢çš„è¾“å‡ºï¼š

```Bash
$ make grade-part4
make -C grade grade-nodejs
make[1]: Entering directory 'grade'
node connect.js
Connected to the server.
Message sent: { token: 'Hello', eog: true }
**Hello! How can I assist you today?**
End of message received.
Connection closed.
Final score: 100
make[1]: Leaving directory 'grade'
```

## Submit Instruction

æ³¨æ„ï¼Œè¿™ä¸ªå®éªŒä¸­ä½ éœ€è¦æäº¤çš„ä»£ç ä»…åŒ…å«`src/`æ–‡ä»¶å¤¹ä¸­çš„ä¸‰ä¸ªæºæ–‡ä»¶ï¼Œæˆ‘ä»¬åœ¨è¯„æµ‹æ—¶ä¹Ÿåªä¼šä½¿ç”¨è¿™ä¸‰ä¸ªæ–‡ä»¶ã€‚

```Bash
#!/bin/bash
# track files, commit changes and push them
git add ./src/*
git commit -m "lab9 has been completed"
git push
```

> ![img](https://ipads.feishu.cn/space/api/box/stream/download/asynccode/?code=ZGRjNjk0NzZlNWVjMTU0YzlhNTYzNGE1MzIwNzJlYTZfcHAwVGZvWk96dmk5Y2Vwd1Z5MnpVNFl5YW5USENZTkdfVG9rZW46UmZEcWIyaTdub2c3Z0Z4SGJNM2NlV0dlblBnXzE3NDcxMDYzMzg6MTc0NzEwOTkzOF9WNA)
>
> æœ‰å¤šä½åŒå­¦åæ˜ æµ‹è¯•æ—¶ç”¨æˆ·ä¸¤æ¬¡å‘é€åŒæ ·å†…å®¹ğŸ¤¯ä½†æ¨¡å‹è¿”å›ç»“æœä¸åŒ
>
> Reference 0utputå¾—åˆ°è¿™æ ·è¾“å‡ºçš„å®é™…åŸå› ä¸ºï¼š
>
> 1. æ¯æ¬¡åˆ›å»ºæ–°çš„ç”¨æˆ·è°ƒç”¨æ¨¡å‹æ—¶ï¼Œå› ä¸ºæ²¡æœ‰ä¸Šä¸‹æ–‡ä¸”å›ºå®šéšæœºç§å­ï¼Œä¸åŒçš„ç”¨æˆ·ç”¨ç›¸åŒpromptæé—®æ¨¡å‹ï¼Œå›å¤ä¼šæ˜¯ä¸€æ ·çš„ï¼›
> 2. åŒä¸€ä¸ªç”¨æˆ·æé—®ï¼Œç¬¬ä¸€æ¬¡çš„è¾“å‡ºæ˜¯ç”¨æˆ·ç¬¬è¿æ¥åç¬¬ä¸€æ¬¡é—®é¢˜è¯·æ±‚çš„è¾“å‡ºï¼Œæœ‰çš„Prompté¦–æ¬¡å›å¤å¸¦äº†æ˜Ÿå·ï¼Œç¬¬äºŒæ¬¡çš„è¾“å‡ºæ²¡æœ‰å¸¦æ˜Ÿå·å› ä¸ºæ¨¡å‹åˆ©ç”¨äº†åŒä¸€ä¸ªç”¨æˆ·çš„ä¸Šä¸‹æ–‡åšå›å¤ï¼Œæ‰€ä»¥ä¸å¸¦æ˜Ÿå·ã€‚
>
> å¦‚æœä¸Reference 0utputä¸ä¸€è‡´ï¼Œè¯·åŒå­¦æ£€æŸ¥è‡ªå·±çš„å®ç°æ˜¯å¦æ­£ç¡®ã€‚